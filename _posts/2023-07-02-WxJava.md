---
layout:       post
title:        "å¾®ä¿¡å…¬ä¼—å·å¼€å‘å­¦ä¹ ç¬”è®°1"
date:        2023-07-02 17:42:41
author:       "Young Sheep"
header-style:      text
catalog:      true
tags:
    - SpringBoot
    - WxJava
    - Javaå¼€å‘ç¬”è®°
---
>ç”±äºæœ€è¿‘çš„é¡¹ç›®éœ€è¦ç”¨åˆ°å¾®ä¿¡å…¬ä¼—å·å¼€å‘ï¼Œç„¶åå°±å‘ç°äº†å¤§ä½¬çš„[WxJava](https://github.com/Wechat-Group/WxJava)é¡¹ç›®ï¼Œä¸€ä¸ªéå¸¸å…¨é¢çš„å¾®ä¿¡å¼€å‘ Java SDKğŸ‘ã€‚
>WxJavaæ”¯æŒåŒ…æ‹¬å¾®ä¿¡æ”¯ä»˜ã€å¼€æ”¾å¹³å°ã€å…¬ä¼—å·ã€ä¼ä¸šå¾®ä¿¡/ä¼ä¸šå·ã€å°ç¨‹åºç­‰å¾®ä¿¡åŠŸèƒ½æ¨¡å—çš„åç«¯å¼€å‘ï¼ŒåŠŸèƒ½ååˆ†å¼ºå¤§ï¼ŒåŸºæœ¬ä¸Šå¾®ä¿¡å¼€å‘å¹³å°çš„æ¥å£éƒ½å®ç°äº†ï¼Œè€Œä¸”å¼€å‘æ–‡æ¡£ååˆ†çš„è¯¦ç»†ï¼Œä¸”æœ‰å¾ˆå¤šä¼˜ç§€çš„æ¡ˆä¾‹å¯ä»¥å­¦ä¹ ï¼Œç®€ç›´æ˜¯ç”¨SpringBootå®ç°å…¬ä¼—å·å¼€å‘çš„æœ€ä½³é€‰æ‹©ã€‚

### å¼•å…¥ä¾èµ–
```java
<dependency>
	<groupId>com.github.binarywang</groupId>
	<artifactId>weixin-java-mp</artifactId>
	<version>4.5.0</version>
</dependency>
```
### é…ç½®ç±»
```java
@AllArgsConstructor
@Configuration
@EnableConfigurationProperties(WxMpProperties.class)
public class WxMpConfiguration {

	//è¿™äº›Handleréƒ½æ˜¯é’ˆå¯¹å¾®ä¿¡å¼€å‘æ–‡æ¡£ç»™å‡ºçš„ç‰¹å®šäº‹ä»¶ç¼–å†™çš„å¤„ç†ç±»ï¼ŒWxMpä¸­å·²ç»å…¨éƒ¨å®ç°ï¼Œç›´æ¥å¤åˆ¶ä»£ç è¿›é¡¹ç›®å³å¯ï¼Œæ ¹æ®ä¸šåŠ¡é€»è¾‘è¿›è¡Œä¿®æ”¹ï¼Œåœ¨ç‰¹å®šäº‹ä»¶è§¦å‘æ—¶è‡ªåŠ¨è°ƒç”¨
    private final LogHandler logHandler;
    private final NullHandler nullHandler;
    private final KfSessionHandler kfSessionHandler;
    private final StoreCheckNotifyHandler storeCheckNotifyHandler;
    private final LocationHandler locationHandler;
    private final MenuHandler menuHandler;
    private final MsgHandler msgHandler;
    private final UnsubscribeHandler unsubscribeHandler;
    private final SubscribeHandler subscribeHandler;
    private final ScanHandler scanHandler;
	
	//è¿™æ˜¯è‡ªå®šä¹‰çš„å¾®ä¿¡å…¬å…±å·å˜é‡ç±»ï¼Œä¾¿äºä»é…ç½®æ–‡ä»¶ä¸­å†™å…¥
    private final WxMpProperties properties;


	//é…ç½®WxMpServiceï¼ŒWxMpServiceä¸­å®ç°äº†å¾®ä¿¡å…¬ä¼—å·çš„å¤§éƒ¨åˆ†æ¥å£ï¼Œåœ¨é¡¹ç›®ä¸­è‡ªåŠ¨æ³¨å…¥ä¾¿å¯è°ƒç”¨
    @Bean
    public WxMpService wxMpService() {
        if (properties == null) {
            throw new RuntimeException("å¤§å“¥ï¼Œæ‹œæ‰˜å…ˆçœ‹ä¸‹é¡¹ç›®é¦–é¡µçš„è¯´æ˜ï¼ˆreadmeæ–‡ä»¶ï¼‰ï¼Œæ·»åŠ ä¸‹ç›¸å…³é…ç½®ï¼Œæ³¨æ„åˆ«é…é”™äº†ï¼");
        }
        WxMpService wxMpService =  new WxMpServiceImpl();
        wxMpService.setMaxRetryTimes(3);
        WxMpDefaultConfigImpl configStorage = new WxMpDefaultConfigImpl();
        configStorage.setAppId(properties.getAppId());
        configStorage.setSecret(properties.getSecret());
        configStorage.setToken(properties.getToken());
        configStorage.setAesKey(properties.getAesKey());
        try {
            wxMpService.addConfigStorage(properties.getAppId(),configStorage);
        }catch (NullPointerException e){
            Logger logger = LoggerFactory.getLogger(getClass());
            logger.info("éœ€åˆå§‹åŒ–configStorageMap...");
            Map<String, WxMpConfigStorage> configStorages = new HashMap<>(4);
            configStorages.put(properties.getAppId(),configStorage);
            wxMpService.setMultiConfigStorages(configStorages,properties.getAppId());
        }
        return wxMpService;
    }

	//æ³¨å…¥ç‰¹å®šäº‹ä»¶çš„è·¯ç”±ï¼Œç”±äºæˆ‘çš„é¡¹ç›®ä¸šåŠ¡é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå°±æ²¡å…³æ³¨è¿™äº›ç‰¹å®šäº‹ä»¶
    @Bean
    public WxMpMessageRouter messageRouter(WxMpService wxMpService) {
        final WxMpMessageRouter newRouter = new WxMpMessageRouter(wxMpService);

        // è®°å½•æ‰€æœ‰äº‹ä»¶çš„æ—¥å¿— ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼‰
        newRouter.rule().handler(this.logHandler).next();

        // æ¥æ”¶å®¢æœä¼šè¯ç®¡ç†äº‹ä»¶
        newRouter.rule().async(false).msgType(EVENT).event(KF_CREATE_SESSION)
            .handler(this.kfSessionHandler).end();
        newRouter.rule().async(false).msgType(EVENT).event(KF_CLOSE_SESSION)
            .handler(this.kfSessionHandler).end();
        newRouter.rule().async(false).msgType(EVENT).event(KF_SWITCH_SESSION)
            .handler(this.kfSessionHandler).end();

        // é—¨åº—å®¡æ ¸äº‹ä»¶
        newRouter.rule().async(false).msgType(EVENT).event(POI_CHECK_NOTIFY).handler(this.storeCheckNotifyHandler).end();

        // è‡ªå®šä¹‰èœå•äº‹ä»¶
        newRouter.rule().async(false).msgType(EVENT).event(EventType.CLICK).handler(this.menuHandler).end();

        // ç‚¹å‡»èœå•è¿æ¥äº‹ä»¶
        newRouter.rule().async(false).msgType(EVENT).event(EventType.VIEW).handler(this.nullHandler).end();

        // å…³æ³¨äº‹ä»¶
        newRouter.rule().async(false).msgType(EVENT).event(SUBSCRIBE).handler(this.subscribeHandler).end();

        // å–æ¶ˆå…³æ³¨äº‹ä»¶
        newRouter.rule().async(false).msgType(EVENT).event(UNSUBSCRIBE).handler(this.unsubscribeHandler).end();

        // ä¸ŠæŠ¥åœ°ç†ä½ç½®äº‹ä»¶
        newRouter.rule().async(false).msgType(EVENT).event(EventType.LOCATION).handler(this.locationHandler).end();

        // æ¥æ”¶åœ°ç†ä½ç½®æ¶ˆæ¯
        newRouter.rule().async(false).msgType(XmlMsgType.LOCATION).handler(this.locationHandler).end();

        // æ‰«ç äº‹ä»¶
        newRouter.rule().async(false).msgType(EVENT).event(EventType.SCAN).handler(this.scanHandler).end();

        // é»˜è®¤
        newRouter.rule().async(false).handler(this.msgHandler).end();

        return newRouter;
    }

}
```
```java
@Data
@ConfigurationProperties(prefix = "wx.mp")
public class WxMpProperties {
    /**
     * æµ‹è¯•ç½‘å€ï¼Œæµ‹è¯•æ—¶éœ€è¦è®¾ç½®æœ¬åœ°ä»£ç†ï¼Œå¹¶åœ¨å¾®ä¿¡å…¬ä¼—å·é¡µé¢é…ç½®ä»£ç†çš„ç½‘å€ï¼Œè¿™æ ·æ‰èƒ½æ¥å—å¾®ä¿¡å…¬ä¼—å·çš„è®¤è¯ä¿¡æ¯
     */
    private String testUrl;
    /**
     * å‰ç«¯è·³è½¬ç½‘å€ï¼Œæ–¹ä¾¿è®¾ç½®è·³è½¬çš„åœ°å€
     */
    private String webUrl;

    /**
     * è®¾ç½®å¾®ä¿¡å…¬ä¼—å·çš„appid
     */
    private String appId;

    /**
     * è®¾ç½®å¾®ä¿¡å…¬ä¼—å·çš„app secret
     */
    private String secret;

    /**
     * è®¾ç½®å¾®ä¿¡å…¬ä¼—å·çš„token
     */
    private String token;

    /**
     * è®¾ç½®å¾®ä¿¡å…¬ä¼—å·çš„EncodingAESKey
     */
    private String aesKey;

    @Override
    public String toString() {
        return JsonUtils.toJson(this);
    }
}
```
